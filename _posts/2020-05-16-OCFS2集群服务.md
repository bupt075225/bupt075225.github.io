>OCFS2集群文件系统是如何初始化并提供服务的呢？实现核心功能的内核模块是在什么时机开始运行？

集群内每个运行OCFS2软件的节点上，都需要启动O2CB服务，它实现集群配置参数的初始化，当用户执行文件系统挂载时，本地节点就加入集群（当多个LUN挂载时，每次都要加入集群吗？）。

### OCFS2集群配置文件

OCFS2集群有两个配置文件：/etc/ocfs2/cluster.conf和/etc/default/o2cb。cluster.conf配置集群节点信息，使用o2cb工具向该配置文件中增删节点信息，如下所示：

    ~# cat/etc/ocfs2/c1uster.conf
    cluster:
            node_count = 3
            name = hosts_pool
    node:
            number = 1           
            cluster = hosts_pool
            ip_port = 7100
            ip_address = 10.125.35.147
            name = nodel47 

    node:
            number = 3
            cluster = hosts_pool
            ip_port = 7100
            ip_address = 10.125.35.144
            name = nodel44

    node:  
            number = 2
            cluster = hosts
            pool ip_port = 7100
            ip_address = 10.125.35.145
            name = nodel45 

o2cb配置集群运行参数，如下所示：

    ~# cat /etc/default/o2cb
    #
    # This is a configuration file for automatic startup of the 02CB
    # driver. It is generated by running /etc/init.d/o2cb configure.
    # On Debian based systems the preferred method is running 'dpkg-reconfigure ocfs2-tools'.
    #

    # O2CB_ENABLED: 'true' means to load the driver on boot.
    O2CB_ENABLED=true 

    # O2CB_BOOTCLUSTER: If not empty, the name of a cluster to start. O2CB_BOOTCLUSTER=hosts_pool

    # O2CB_HEARTBEAT_THRESHOLD: Iterations before a node is considered dead.
    O2CB_HEARTBEAT_THRESHOLD=61 

    # O2CB_IDLE_TIMEOUT_MS: Time in ms before a network connection is considered dead.
    O2CB_IDLE_TIMEOUT_MS=90000

    # O2CB_KEEPALIVE_DELAY_MS: Max. time in ms before a keepalive packet is sent.
    O2CB_KEEPALIVE_DELAY_MS=10000

    # O2CB_RECONNECT_DELAY_MS: Min. time in ms between connection attempts.
    O2CB_RECONNECT_DELAY_MS=2000

    #O2CB_FENCE_METHOD: How to fence one node
    O2CB_FENCE_METHOD=reset

### O2CB服务

o2cb.ini是O2CB服务启动脚本，该脚本的核心功能是加载内核模块，通过configfs接口将集群配置信息设置到内核模块中。

首先，依次加载ocfs2\_stackglue，ocfs2\_stack\_o2cb，ocfs2\_dlmfs三个内核模块，加载ocfs2_stackglue后，在/sys/fs目录下会出现ocfs2目录：

    ~# ls -l /sys/fs/ocfs2/
    total 0
    -r--r--r-- 1 root root 4096 Jun 26 17:36 active_cluster_plugin
    -rw-r--r-- 1 root root 4096 Jun 26 17:36 cluster_stack
    -r--r--r-- 1 root root 4096 Jun 26 17:36 dlm_recover_callback_support
    -r--r--r-- 1 root root 4096 Jun 26 17:36 loaded_cluster_plugins
    -r--r--r-- 1 root root 4096 Jun 26 17:36 max_locking_protocol

加载ocfs2\_stack\_o2cb的同时，加载依赖的其它模块。

其次，使用o2cb register_cluster命令，在/sys/kernel/config/cluster目录下创建目录，设置参数。

    ~# tree /sys/kernel/config/cluster/
    /sys/kernel/config/cluster/
    |-- hosts pool
    |   |-- fence_method
    |   |-- heartbeat
    |   |   |-- dead_threshold
    |   |   `-- mode
    |   |-- idle_timeout_ms
    |   |-- keepallve_delay_ms
    |   |-- node
    |   |   |--node1
    |   |      |-- ipnet_type
    |   |      |-- ipv4_address
    |   |      |-- ipv4_port
    |   |      |-- local
    |   |      `-- num
        `-- reconnect delay ms
 
    4 directories, 11 files 

挂载后：

    ~# tree /sys/kernel/config/cluster/hosts_pool/heartbeat/
    /sys/kernel/config/cluster/hosts_pool/heartbeat/
    |-- dead_threshold
    |-- F1F1134B03CD431CBA33C10FCCB840BF
    |   |-- block_bytes
    |   |-- blocks
    |   |-- dev
    |   |-- pid
    |   `-- start_block
    `-- mode

    1 directory, 7 files