
Linux中提供rpmbuild命令，它被用来生成RPM包。在执行rpmbuild命令构建RPM包之前，需要做几件准备工作：

- 创建目录结构。
- 配置宏
- 编写spec文件

### 创建目录

创建以下这些平级的目录：

BUILD 源码被解压缩后放置该目录下，在这里编译源码。

RPMS 放置生成的RPM包

SOURCES 放置源码压缩包(tarball)

SPECS 放置spec文件

SRPMS 放置生成的源码RPM包

使用如下命令完成目录的创建：

    mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}

### 配置宏

- 宏定义的语法

RPM构建系统的宏与编程语言中的变量相似。宏定义的格式如下：

    %define macro_name value

例如：%_sysconfdir /etc

宏名称是_sysconfdir，值是/etc

引用宏的方法如下：

    %{macro_name}或%macro_name

宏定义中还可以使用如下语法展开shell命令输出：

    %(cmd)

示例：%define cur_dir %(pwd)

RPM构建系统提供了一些内置的宏，在CentOS系统`/usr/lib/rpm/redhat/macros`目录文件中定义了所有的内置宏定义。

rpm命令可以展开宏定义，查看它的值。

    rpm --eval %macro_name

示例：

    $ rpm --eval %sysconfdir
    /etc

- 定义宏

除了内置宏以外，还可以定义新宏。新宏可以定义在spec文件中，也可以定义在配置文件.rpmmacros中。

在配置文件.rpmmacros中设置构建环境的顶层工作目录：

    echo "%_topdir %(echo $HOME)/rpmbuild" > ~/.rpmmacros

_topdir是内置的宏，这里修改了它的值。

>注意：如果配置文件.rpmmacros已存在，这样会覆盖原有配置

### 编写spec文件

spec文件就是rpmbuild命令的操作指南，它定好了打包过程有哪些信息，要执行哪些动作，最后生成RPM包。

spec文件通常包含:

- 包头部信息
- 包描述信息(%description)
- %prep 预处理
- %build 编译
- %install 安装
- %files RPM包含的文件列表
- %clean 清理

spec文件本质上是一个shell脚本，上述那些部分就好比是一个个功能函数。与shell脚本不同的地方是spec文件还包含了宏(类似于shell中的变量)，这和用Python开发的自动化部署工具Fabric部署脚本很类似。

官方给出的Group列表定义在` /usr/share/doc/rpm-4.11.3/GROUPS`文件中。

### 构建RPM包

运行如下命令生成RPM包：

    rpmbuild -ba ~/rpmbuild/SPECS/my.spec

### 参考链接：

- [RPM Guide](https://docs.fedoraproject.org/en-US/Fedora_Draft_Documentation/0.1/html/RPM_Guide/)
- [Maximum RPM](http://ftp.rpm.org/max-rpm/index.html)