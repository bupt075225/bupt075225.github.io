OCFS2是一个集群文件系统，最初由Oracle公司开发，并合入Linux主线。OCFS2的一个应用场景是在云计算虚拟化产品中实现共享存储，用来存放虚拟机磁盘镜像文件。安装OCFS2软件的多台主机组成一个OCFS2服务集群，用传统企业级SAN存储提供共享的存储空间，映射一个LUN给集群中的每一台主机，在LUN上建立OCFS2文件系统。最终的效果就相当于集群中所有主机共用一块硬盘并被格式化为OCFS2文件系统。OCFS2集群文件系统保证多台主机读写共享盘的数据一致性和完整性。

###此处应该有一张应用场景示意图

OCFS2软件包含用户态的ocfs2-tools工具集和内核态两大部分，内核态实现文件系统、集群管理、分布式锁。

###此处应该有一张模块划分图

内核态有如下这些模块：

    ~# lsmod | grep ocfs2
    ocfs2_dlmfs        24576    1
    ocfs2_stack_o2cb   16384    1
    ocfs2_dlm          229376   1  ocfs2_stack_o2cb
    ocfs2              1044480  4
    quota_tree         20480    1  ocfs2
    ocfs2_nodemanager  274432   19 ocfs2_dlmfs,ocfs2_stack_o2cb,ocfs2_dlm,ocfs2
    ocfs2_stackglue    20480    3  ocfs2_dlmfs,ocfs2_stack_o2cb,ocfs2
    jbd2               106496   2  ocfs2,ext4

文件系统的大部分实现与ext4类似，文件系统的空间管理与单机文件系统有差异，需要满足集群内各节点对空间的申请与释放需求，以及文件系统元数据的一致性。

OCFS2使用分布式锁实现集群内的资源访问互斥，分布式锁的实现依赖节点间的TCP消息交互，因此需要实现一个TCP消息模块。

集群节点管理依赖磁盘心跳，集群内各节点通过探测其它节点的心跳来感知节点的加入与离开。节点间建立TCP连接形成消息通信网络，通过保活消息探测连接是否异常，当本地节点与有心跳活动的大多数节点连接异常时，会退出集群，以防止出现网络分区。

集群的故障点主要包括以下两点，一是节点与SAN存储间的存储网络故障，二是节点间的TCP网络故障。

用户态的工具集常用的有这些：

* debugfs.ocfs2    读取磁盘上的超级块，保存元数据的系统文件等
* tunefs.ocfs2     在线查询及修改文件系统的参数(通常是保存在超级块中)
* mount.ocfs2      挂载文件系统时启动内核心跳线程，调用系统的mount
* ocfs2\_hb\_ctl   启动与暂停心跳
* o2cb             集群管理工具，向集群配置文件中增、删、查节点信息
* fsck.ocfs2       元数据检查及修复工具
* mkfs.ocs2        文件系统格式化工具